<div>
    <nav>
        <h1>Manage</h1>
    </nav>
    <main>
        <p>Here you can manage your server, view server system, shutdown server or etc.</p>
        <div class="server">
            <div class="server-info">
                <h2>Server Information</h2>
                <div class="ip-div">
                    <p>IP Address: <p id="ip-address-and-port"></p></p>
                </div>
            </div>
            <div class="server-commands">
                <h2>Commands</h2>
                <div class="server-command">
                    <button id="shutdown-btn">Shutdown server</button>
                    <button id="restart-btn">Restart server</button>
                    <button id="stat-nginx-btn">Nginx status</button>
                    <button id="restart-nginx-btn">Restart Nginx</button>
                    <button id="stat-jellyfin-btn">Jellyfin status</button>
                    <button id="restart-jellyfin-btn">Restart Jellyfin</button>
                    <button id="stat-cloudflared-btn">Cloudflared status</button>
                    <button id="chk-nginx-log">Check nginx log file</button>
                </div>
                <div id="output-command">You can see the command output here...</div>
            </div>
            <div class="server-system">
                <h2>Check System</h2>
                <div class="server-sys">
                    <button id="srv-stat">Check Server Status</button>
                    <button id="chk-os">Check Os Info</button>
                    <button id="chk-cpu">Check CPU Info</button>
                    <button id="chk-disk">Check Disk Info</button>
                    <button id="chk-net">Check Network Info</button>
                </div>
                <div id="output-system">You can see the system output here...</div>
            </div>
        </div>
    </main>
</div>

<script>
    import { get_base_url } from "../utils/api-base-url";
    import { 
        shutdown_server, 
        restart_server, 
        get_nginx_status, 
        restart_nginx, 
        get_jellyfin_status, 
        restart_jellyfin,
        get_cloudflared_status ,
        get_log_nginx,
        read_log_nginx
    } from "../utils/server-command";
    import { 
        get_server_os_info, 
        get_server_status, 
        get_cpu_info, 
        get_disk_info, 
        get_network_info 
    } from '../utils/server-system';

    const ip_display = document.getElementById('ip-address-and-port') as HTMLParagraphElement;
    const shut_btn = document.getElementById('shutdown-btn') as HTMLButtonElement;
    const rest_btn = document.getElementById('restart-btn') as HTMLButtonElement;
    const stat_nginx_btn = document.getElementById('stat-nginx-btn') as HTMLButtonElement;
    const stat_jellyfin_btn = document.getElementById('stat-jellyfin-btn') as HTMLButtonElement;
    const output_div_command = document.getElementById('output-command') as HTMLDivElement;
    const output_div_system = document.getElementById('output-system') as HTMLDivElement;
    const chk_os_btn = document.getElementById('chk-os') as HTMLButtonElement;
    const srv_stat_btn = document.getElementById('srv-stat') as HTMLButtonElement;
    const rest_nginx_btn = document.getElementById('restart-nginx-btn') as HTMLButtonElement;
    const rest_jell_btn = document.getElementById('restart-jellyfin-btn') as HTMLButtonElement;
    const chk_cpu_btn = document.getElementById('chk-cpu') as HTMLButtonElement;
    const chk_disk_btn = document.getElementById('chk-disk') as HTMLButtonElement;
    const chk_net_btn = document.getElementById('chk-net') as HTMLButtonElement;
    const stat_cloudflared_btn = document.getElementById('stat-cloudflared-btn') as HTMLButtonElement;
    const chk_nginx_log_btn = document.getElementById('chk-nginx-log') as HTMLButtonElement;

    ip_display.textContent = get_base_url();
    
    shut_btn.addEventListener('click', async () => {
        const data = await shutdown_server();
        if(!data) return;
        const {
            res_code,
            message
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nServer: ${message}`;
    });
    rest_btn.addEventListener('click', async () => {
        const data = await restart_server();
        if(!data) return; 
        const {
            res_code,
            message
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nServer: ${message}`;
    });
    stat_nginx_btn.addEventListener('click', async () => {
        const data = await get_nginx_status();
        if(!data) return;
        const {
            res_code,
            nginx_details
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nNginx Details: ${nginx_details}`;
    });
    rest_nginx_btn.addEventListener('click', async () => {
        const data = await restart_nginx();
        if(!data) return;
        const {
            res_code,
            message_restart_nginx
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nNginx Message: ${message_restart_nginx}`;
    });
    stat_jellyfin_btn.addEventListener('click', async () => {
        const data = await get_jellyfin_status();
        if(!data) return;
        const {
            res_code,
            jellyfin_details
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nJellyfin Status: ${jellyfin_details}`;
    });
    rest_jell_btn.addEventListener('click', async () => {
        const data = await restart_jellyfin();
        if(!data) return;
        const {
            res_code,
            message_restart_jellyfin
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nJellyfin Message: ${message_restart_jellyfin}`;
    });
    stat_cloudflared_btn.addEventListener('click', async () => {
        const data = await get_cloudflared_status();
        if(!data) return;
        const {
            res_code,
            cloudflared_details
        } = data;

        output_div_command.textContent = `Response Code: ${res_code}\nCloudflared Status: ${cloudflared_details}`;
    });
    chk_nginx_log_btn.addEventListener('click', async () => {
        const data = await get_log_nginx();
        if(!data) return;
        const {
            res_code,
            list_file
        } = data;

        output_div_command.innerHTML = `Response Code: ${res_code}<br><div id="log-buttons-container"></div><div id="log-content-display"></div>`;
    
        const container = document.getElementById('log-buttons-container') as HTMLDivElement;

        list_file.forEach((fileName: string | null) => {
            const btn = document.createElement('button');
            
            btn.textContent = fileName;
            btn.style = 'color: white; background: black; border: 1px solid cyan; margin: 2px; padding: 4px; cursor: pointer;';
            btn.onclick = async () => {
                const content = await read_log_nginx(fileName); 
                const log_display = document.getElementById('log-content-display') as HTMLDivElement;
                log_display.textContent = `\nReading File: ${fileName}\nLog: \n${content}`;
            };

            container.appendChild(btn);
        });
    })

    
    
    chk_os_btn.addEventListener('click', async () => {
        const data = await get_server_os_info();
        if(!data) return;
        const {
            res_code,
            platform,
            distro,
            release,
            kernel,
            arch
        } = data;

        output_div_system.textContent = `Response Code: ${res_code}\nPlatform: ${platform}\nDistro: ${distro}\nRelease: ${release}\nKernel: ${kernel}\nArchitecture: ${arch}`;
    });
    srv_stat_btn.addEventListener('click', async () => {
        const data = await get_server_status();
        if(!data) return;
        const { 
            res_code, 
            cpu_load, 
            os_distro, 
            memory_total, 
            memory_free, 
            memory_used, 
            disk_name, 
            disk_used, 
            disk_free, 
            disk_size 
        } = data;

        output_div_system.textContent = `Response Code: ${res_code}\nCPU Load: ${cpu_load}\nOS Distro: ${os_distro}\n---Memory---\nMemory Total: ${memory_total} GB\nMemory Free: ${memory_free} GB\nMemory Used: ${memory_used} GB\n---Disk---\nDisk: ${disk_name}\nDisk Used: ${disk_used} GB\nDisk Free: ${disk_free} GB\nDisk Total: ${disk_size} GB`
    });
    chk_cpu_btn.addEventListener('click', async () => {
        const data = await get_cpu_info();
        if(!data) return;
        const {
            res_code,
            manufacturer,
            brand,
            speed,
            cores,
            physicalCores
        } = data;

        output_div_system.textContent = `Response Code: ${res_code}\nCPU Brand: ${manufacturer} ${brand}\nCPU Speed: ${speed} GHz\nCPU Cores: ${cores}\nCPU Physical Cores: ${physicalCores}`;
    });
    chk_disk_btn.addEventListener('click', async () => {
        const data = await get_disk_info();
        if(!data) return;
        let {
            res_code,
            disk_type,
            disk,
            disk_vendor
        } = data;

        if(disk_type === 'HD') {
           const type = 'Harddisk';
           disk_type = type;
        }

        output_div_system.textContent = `Response Code: ${res_code}\nDisk Vendor: ${disk_vendor}\nDisk Type: ${disk_type}\nDisk: ${disk}`;
    });
    chk_net_btn.addEventListener('click', async () => {
        const data = await get_network_info();
        if (!data) return;

        const network_stats = data.main_interface;
        let output_text = `Response Code: ${data.res_code}\n--- Network Interfaces ---`;
        const interfaces = Object.keys(network_stats);
    
        const wireless_key = interfaces.find(name => name.startsWith('wl'));

        if (wireless_key) {
            const wlan_data = network_stats[wireless_key];
            output_text += `\n[ WIRELESS (${wireless_key}) ]\n`;
            output_text += `Type: ${wlan_data.type}\n`;
            output_text += `RX Traffic: ${wlan_data.bytes_received_MB} MB/s\n`;
            output_text += `TX Traffic: ${wlan_data.bytes_sent_MB} MB/s\n`;
            output_text += `Packets RX: ${wlan_data.packets_received.toFixed(0)} p/s\n`;
        } else {
            output_text += `\n[ WIRELESS ]\nStatus: Not found or inactive.\n`;
        }

        const ethernet_key = interfaces.find(name => name.startsWith('en'));

        if (ethernet_key) {
            const eth_data = network_stats[ethernet_key];
            output_text += `\n[ ETHERNET (${ethernet_key}) ]\n`;
            output_text += `Type: ${eth_data.type}\n`;
            output_text += `RX Traffic: ${eth_data.bytes_received_MB} MB/s\n`;
            output_text += `TX Traffic: ${eth_data.bytes_sent_MB} MB/s\n`;
            output_text += `Packets RX: ${eth_data.packets_received.toFixed(0)} p/s\n`;
        } else {
            output_text += `\n[ ETHERNET ]\nStatus: Not found or inactive.\n`;
        }

        output_div_system.textContent = output_text;
    });
</script>

<style>
    * {
        padding: 0;
        margin: 0;
    }

    :root {
        --backg: rgb(10, 15, 44);
        --color: rgb(215, 218, 223);
        --sss: rgb(21, 24, 34);
        --ws: whitesmoke;
        --btn: rgb(10, 16, 60);
        --bc: white;
        --bb: rgb(104, 105, 103);
        --bch: aquamarine;
        --ob: rgb(10, 15, 44);
    }

    nav {
        background: var(--backg);
        color: var(--color);
        border-bottom: 1px solid var(--ws);
        padding: 2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    main {
        padding: 16px;
        color: var(--color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .server {
        width: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .server-info {
        margin-top: 16px;
        background: var(--sss);
        border: 1px solid var(--ws);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    h2::after {
        content: "";
        display: block;
        width: 100%;
        height: 1px;
        background: var(--ws);
        margin-top: 4px;
    }

    .ip-div {
        display: flex;
        gap: 8px;
    }

    .server-commands, .server-system {
        background: var(--sss);
        border: 1px solid var(--ws);
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        word-break: break-all;
    }

    button {
		background: var(--btn);
		color: var(--bc);
		border: 1px solid var(--bb);
		padding: 4px;
        margin: 2px 0;
	}

	button:hover {
		cursor: pointer;
		color: var(--bch);
		background: var(--bb);
		border: 1px solid var(--btn);
	}

    #output-command, #output-system {
        background: var(--ob);
        border: 1px solid var(--ws);
        padding: 8px;
        margin-top: 8px;
        height: auto;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
    }
</style>